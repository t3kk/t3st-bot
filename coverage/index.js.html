<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for index.js</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="prettify.css" />
    <link rel="stylesheet" href="base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="index.html">All files</a> index.js
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>0/76</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>0/24</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>0/15</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>0/74</span>
      </div>
    </div>
  </div>
  <div class='status-line low'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176</td><td class="line-coverage quiet"><span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">let Discord = <span class="cstat-no" title="statement not covered" >require('discord.io');</span>
let config = <span class="cstat-no" title="statement not covered" >require('../config.js');</span>
let youtubeDL = <span class="cstat-no" title="statement not covered" >require('youtube-dl');</span>
&nbsp;
let {addToQueue, setStreamChannel, setVolume, toggleShuffle}
  = <span class="cstat-no" title="statement not covered" >require('./musicControls');</span>
let {download} = <span class="cstat-no" title="statement not covered" >require('./downloadQueue');</span>
&nbsp;
let voiceChannel = <span class="cstat-no" title="statement not covered" >'314260605177692163';</span> //  Novron
let textChannel = <span class="cstat-no" title="statement not covered" >'286204341809840129';</span> // Novron
// let voiceChannel = '219530331357839370'; // audio test
// let voiceChannel = '236302765612204042'; // The Apple
// let textChannel = '236302765180059659'; // The Apple
&nbsp;
// Define some stuff!!!
// TODO move this out to some singletons for easier access?
let volumeRegex = <span class="cstat-no" title="statement not covered" >/^@(?:vol|volume) (100|[0-9]{1,2})/;</span>
&nbsp;
let bot = <span class="cstat-no" title="statement not covered" >new Discord.Client({</span>
  token: config.token,
  autorun: true,
});
&nbsp;
<span class="cstat-no" title="statement not covered" >bot.on('ready', <span class="fstat-no" title="function not covered" >fu</span>nction() {</span>
<span class="cstat-no" title="statement not covered" >  console.log(bot.username + ' - (' + bot.id + ')');</span>
  // TODO: Check that the voice channel is truely active
<span class="cstat-no" title="statement not covered" >  console.log('channels before connect:');</span>
<span class="cstat-no" title="statement not covered" >  Object.keys(bot.channels).forEach(<span class="fstat-no" title="function not covered" >ke</span>y =&gt; {</span>
<span class="cstat-no" title="statement not covered" >    console.log(bot.channels[key]);</span>
  });
<span class="cstat-no" title="statement not covered" >  console.log('done listing channels');</span>
<span class="cstat-no" title="statement not covered" >  bot.joinVoiceChannel(voiceChannel, <span class="fstat-no" title="function not covered" >fu</span>nction(error) {</span>
<span class="cstat-no" title="statement not covered" >    if (error) <span class="cstat-no" title="statement not covered" >return console.error(error);</span></span>
<span class="cstat-no" title="statement not covered" >    bot.getAudioContext(voiceChannel, <span class="fstat-no" title="function not covered" >fu</span>nction(err, stream) {</span>
<span class="cstat-no" title="statement not covered" >      if (err) <span class="cstat-no" title="statement not covered" >return console.error(err);</span></span>
<span class="cstat-no" title="statement not covered" >      console.log('voice chan');</span>
<span class="cstat-no" title="statement not covered" >      console.log(bot.channels[voiceChannel]);</span>
    });
  });
});
&nbsp;
// Handle Disconnects
<span class="cstat-no" title="statement not covered" >bot.on('disconnect', <span class="fstat-no" title="function not covered" >fu</span>nction() {</span>
<span class="cstat-no" title="statement not covered" >  console.log('encountered disconnect');</span>
<span class="cstat-no" title="statement not covered" >  bot.connect();</span>
});
&nbsp;
<span class="cstat-no" title="statement not covered" >bot.on('message', <span class="fstat-no" title="function not covered" >fu</span>nction(user, userID, channelID, message, event) {</span>
  // If the message starts with roll,
  // take the first instance of the dice regex and give the result
  //  TODO: error checking
<span class="cstat-no" title="statement not covered" >  if (message.startsWith('@roll ')) {</span>
    //  TODO: use matching group so we can switch on the command part
    let diceRegex = <span class="cstat-no" title="statement not covered" >/!roll (\d*)(d)(\d+)( for .*)?/;</span>
    let requestedRole = <span class="cstat-no" title="statement not covered" >diceRegex.exec(message);</span>
    //  If the numebr of rolls wasn't defined, set it to 1
    let numberOfRolls = <span class="cstat-no" title="statement not covered" >requestedRole[1] ? requestedRole[1] : 1;</span>
    let dieType = <span class="cstat-no" title="statement not covered" >requestedRole[3];</span>
    //  If there is no reason supplied make the explanation for the roll blank.
    let reason = <span class="cstat-no" title="statement not covered" >requestedRole[4] ? requestedRole[4] : '';</span>
    let sum = <span class="cstat-no" title="statement not covered" >0;</span>
    let rolls = <span class="cstat-no" title="statement not covered" >[];</span>
<span class="cstat-no" title="statement not covered" >    for (let i = 0; i &lt; numberOfRolls; i++) {</span>
      let roll = <span class="cstat-no" title="statement not covered" >Math.ceil(Math.random() * dieType);</span>
<span class="cstat-no" title="statement not covered" >      rolls.push(roll);</span>
<span class="cstat-no" title="statement not covered" >      sum += roll;</span>
    }
    let response = <span class="cstat-no" title="statement not covered" >`@${user} rolled ${numberOfRolls} d${dieType} ` +</span>
      `for a total of ${sum}${reason}.  Rolls were ${rolls}.`;
<span class="cstat-no" title="statement not covered" >    bot.sendMessage({</span>
      to: channelID,
      message: response,
    });
  }
<span class="cstat-no" title="statement not covered" >  if (message.startsWith('@play ')) {</span>
    // TODO: vlaidate URL with https://gist.github.com/dperini/729294 ?
    // TODO: split into its own function
    // get the url
    let url = <span class="cstat-no" title="statement not covered" >message.substr(6);</span>
<span class="cstat-no" title="statement not covered" >    bot.simulateTyping(channelID);</span>
    let time = <span class="cstat-no" title="statement not covered" >new Date().getTime();</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >    youtubeDL.getInfo(url, [],</span>
      {maxBuffer: Infinity},
      function <span class="fstat-no" title="function not covered" >exec(</span>err, info) {
<span class="cstat-no" title="statement not covered" >        if (err) {</span>
<span class="cstat-no" title="statement not covered" >          throw err;</span>
        } else {
<span class="cstat-no" title="statement not covered" >          console.log(`parser time: ${(new Date().getTime()) - time}`);</span>
          // Check if its a playlist
<span class="cstat-no" title="statement not covered" >          if (Array.isArray(info)) {</span>
<span class="cstat-no" title="statement not covered" >            info.forEach( <span class="fstat-no" title="function not covered" >(e</span>ntry) =&gt; {</span>
<span class="cstat-no" title="statement not covered" >              downloadFile(entry, event);</span>
            });
          } else { // it is a single song
<span class="cstat-no" title="statement not covered" >            downloadFile(info, event);</span>
          }
        }
      }
    );
  }
<span class="cstat-no" title="statement not covered" >  if (volumeRegex.exec(message)) {</span>
    let newVolume = <span class="cstat-no" title="statement not covered" >volumeRegex.exec(message)[1];</span>
<span class="cstat-no" title="statement not covered" >    console.log(`1:) setting volume to ${newVolume}`);</span>
<span class="cstat-no" title="statement not covered" >    setVolume(newVolume);</span>
  }
&nbsp;
  // TODO: check that the stream is initialized and if not do it.
<span class="cstat-no" title="statement not covered" >  if (message.startsWith('@shuffle')) {</span>
<span class="cstat-no" title="statement not covered" >    toggleShuffle();</span>
  }
});
&nbsp;
//  Handle ctrl + c and shutdown cleanly
<span class="cstat-no" title="statement not covered" >process.on('SIGINT', <span class="fstat-no" title="function not covered" >fu</span>nction() {</span>
<span class="cstat-no" title="statement not covered" >  console.log('RYAN got interrupt');</span>
<span class="cstat-no" title="statement not covered" >  bot.disconnect();</span>
<span class="cstat-no" title="statement not covered" >  process.exit();</span>
});
&nbsp;
function <span class="fstat-no" title="function not covered" >downloadFile(</span>entry, event) {
  // Send each URL to the download queue
<span class="cstat-no" title="statement not covered" >  console.log(`\n\n${entry.webpage_url}\n${entry.title}`);</span>
<span class="cstat-no" title="statement not covered" >  download(entry.webpage_url, <span class="fstat-no" title="function not covered" >fu</span>nction(success, fileName) {</span>
<span class="cstat-no" title="statement not covered" >    if (success) {</span>
<span class="cstat-no" title="statement not covered" >      setupStream();</span>
<span class="cstat-no" title="statement not covered" >      addToQueue(fileName, getMentionStringForSender(event));</span>
    } else {
      // TODO send message to channel or requester about failure
<span class="cstat-no" title="statement not covered" >      console.log(`Failed to download ${entry.title}[${entry.webpage_url}]`);</span>
    }
  });
}
&nbsp;
&nbsp;
/**
 * Takes a file and a message event.  Removes the message from the channel that
 * the message was on and queues the file up for playback.
 * @param {string} output
 * @param {object} messageEvent
 */
function <span class="fstat-no" title="function not covered" >queueFile(</span>output, messageEvent) {
  // TODO Rename to somethign involving getting the file name and move out
  // Kinda trustingly get file name... Make this seletcion safer if possible
&nbsp;
&nbsp;
}
&nbsp;
/**
 * Removes a message from the channel it was posted by using data contained in the message event itself.
 * @param {object} messageEvent
 */
function <span class="fstat-no" title="function not covered" >removeMessageByEvent(</span>messageEvent) {
  let messageId = <span class="cstat-no" title="statement not covered" >messageEvent.d.id;</span>
  let channelId = <span class="cstat-no" title="statement not covered" >messageEvent.d.channel_id;</span>
<span class="cstat-no" title="statement not covered" >  bot.deleteMessage(channelId, messageId);</span>
}
/**
 * @param {object} messageEvent
 * @return {string} that can be used to mention the sender of the message related to the messageEvent
 */
function <span class="fstat-no" title="function not covered" >getMentionStringForSender(</span>messageEvent) {
<span class="cstat-no" title="statement not covered" >  return `&lt;@${messageEvent.d.author.id}&gt;`;</span>
}
&nbsp;
let streamSetup;
/**
 * Initializes variables in src/musicControls.js...  Probably refactor this.
 */
function <span class="fstat-no" title="function not covered" >setupStream(</span>) {
<span class="cstat-no" title="statement not covered" >  if (!streamSetup) {</span>
<span class="cstat-no" title="statement not covered" >    streamSetup = true;</span>
<span class="cstat-no" title="statement not covered" >    setStreamChannel(bot, voiceChannel, textChannel);</span>
  }
}
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="https://istanbul.js.org/" target="_blank">istanbul</a> at Thu Oct 26 2017 16:24:37 GMT-0400 (EDT)
</div>
</div>
<script src="prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="sorter.js"></script>
</body>
</html>
